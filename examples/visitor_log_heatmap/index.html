<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Map visitors to your website</title>
<link rel="stylesheet" type="text/css" href="history/history.css" />
<script src="AC_OETags.js" language="javascript"></script>
<script src="history/history.js" language="javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="ajaxupload.3.6.js"></script>
<style>
body {
	font-family:"lucida grande", "verdana";
	font-size:11px;
	margin:0px;
	padding:0px;
	text-align:left;
}

div {
    background-color: #fff;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border: 1px solid #000;
    padding: 10px;
    margin: 10px;
    font-size: 100%;
    width: 850px;
}

div.button {
	width: 100px;
	background-color: #eee;
	color: #000000;
	text-align: center;
}

div.button.hover {
	background-color: #fff;
}

</style>
<script type="text/javascript">
var requiredMajorVersion = 9;
var requiredMinorVersion = 0;
var requiredRevision = 124;

function insertOpenGraphMap(source, id)
{
    // Version check for the Flash Player that has the ability to start Player Product Install (6.0r65)
    var hasProductInstall = DetectFlashVer(6, 0, 65);

    // Version check based upon the values defined in globals
    var hasRequestedVersion = DetectFlashVer(requiredMajorVersion, requiredMinorVersion, requiredRevision);

    if ( hasProductInstall && !hasRequestedVersion ) 
    {
        // DO NOT MODIFY THE FOLLOWING FOUR LINES
        // Location visited after installation is complete if installation is required
        var MMPlayerType = (isIE == true) ? "ActiveX" : "PlugIn";
        var MMredirectURL = window.location;
        document.title = document.title.slice(0, 47) + " - Flash Player Installation";
        var MMdoctitle = document.title;

        AC_FL_RunContent(
            "src", "playerProductInstall",
            "FlashVars", "MMredirectURL="+MMredirectURL+'&MMplayerType='+MMPlayerType+'&MMdoctitle='+MMdoctitle+"",
            "width", "800",
            "height", "600",
            "align", "middle",
            "id", id,
            "quality", "high",
            "bgcolor", "#869ca7",
            "name", "mapview",
            "allowScriptAccess","sameDomain",
            "type", "application/x-shockwave-flash",
            "pluginspage", "http://www.adobe.com/go/getflashplayer"
        );
    } 
    else if (hasRequestedVersion) 
    {
        // if we've detected an acceptable version
        // embed the Flash Content SWF when all tests are passed
        AC_FL_RunContent(
            "src", source,
            "width", "800",
            "height", "600",
            "align", "middle",
            "id", id,
            "quality", "high",
            "bgcolor", "#869ca7",
            "name", "mapview",
            "allowScriptAccess","sameDomain",
            "type", "application/x-shockwave-flash",
            "pluginspage", "http://www.adobe.com/go/getflashplayer"
        );
    } else {
        var alternateContent = 'Flash not found - '
        + 'This content requires the Adobe Flash Player. '
        + '<a href=http://www.adobe.com/go/getflash/>Get Flash</a>';
        document.write(alternateContent);  // insert non-flash content
    }
}

function getOpenGraphMap(mapName) {
    var isIE = navigator.appName.indexOf("Microsoft") != -1;
    return (isIE) ? window[mapName] : document.getElementById(mapName);
}

</script>

<script type="text/javascript">

$(document).ready(function(){

	/* example 1 */
	var button = $('#upload_button'), interval;
	new AjaxUpload(button,{
		action: 'accesslogtocsv.php', 
		name: 'input_file',
        responseType: 'json',
		onSubmit : function(file, ext){
			// change button text, when user selects file			
			button.text('Uploading');
			
			// If you want to allow uploading only 1 file at time,
			// you can disable upload button
			this.disable();
			
			// Uploding -> Uploading. -> Uploading...
			interval = window.setInterval(function(){
				var text = button.text();
				if (text.length < 13){
					button.text(text + '.');					
				} else {
					button.text('Uploading');				
				}
			}, 200);
		},
		onComplete: function(file, response){
			button.text('Upload');
						
			window.clearInterval(interval);
						
			// enable upload button
			this.enable();
			
            var map = getOpenGraphMap("maprender");
            map.loadValuesFromCSVString(response.csv_string);
		}
	});
});

function onMapCreated()
{
    var map = getOpenGraphMap("maprender");

    map.setLatLonViewingArea(50, -126.58, 15, -66.73);
    
    map.setEventHandler('mousemove', 'onMouseMove');
    map.setEventHandler('datachange', 'onDataChange');
    map.setEventHandler('waysload', 'onWaysLoad');
    map.setEventHandler('valuesload', 'onValuesLoad');
    map.setEventHandler('error', 'onError');
    map.setGradientValueRange(0, 20);
    map.setSetting('point_blob_radius', 1.0);

    map.addInlay(50, 325, 250, 525, 72, -170, 52, -130);
    map.addInlay(300, 450, 500, 550, 22, -163, 15, -147);

    map.loadWaysFromFile('us_counties.osm');
//    map.loadValuesFromFile('poi.csv');
    
    setInfoDisplayHTML('Loading map<br/><img src="loading.gif"/>');    
}

var g_areWaysLoaded = false;
var g_areValuesLoaded = true;

function onWaysLoad(filename)
{
    g_areWaysLoaded = true;
    
    if (g_areValuesLoaded)
    {
        setInfoDisplayHTML('');
    }
    else
    {
        setInfoDisplayHTML('Loading values<br/><img src="loading.gif"/>');    
    }
    
    return true;
}

function onValuesLoad(filename)
{
    g_areValuesLoaded = true;
    
    if (g_areWaysLoaded)
    {
        setInfoDisplayHTML('');
    }
    else
    {
        setInfoDisplayHTML('Loading map<br/><img src="loading.gif"/>');    
    }
    
    return true;
}

function onError(message)
{
    setInfoDisplayHTML(message);
}

var g_lastEvent = null;

function onMouseMove(event)
{
    g_lastEvent = event;

    updateInfoDisplay(event);
    
    return true;
}

function onDataChange()
{
    updateInfoDisplay(g_lastEvent);
    
    return true;
}

function updateInfoDisplay(event)
{
    if (!g_areWaysLoaded||!g_areValuesLoaded)
        return;

    var map = getOpenGraphMap("maprender");

    var infoHTML = '';

    var points = map.getValuePointsNearLatLon(event.lat, event.lon);
    var pointsLength = points.length;
    if (pointsLength<1)
    {
        infoHTML += 'Nothing found';
    }
    else
    {
        var pointNames = [];
        for (var pointIndex in points)
        {
            var point = points[pointIndex];
            
            var url = point.url;
            
            pointNames.push(url);
        }
    
        infoHTML += pointNames.join('<br>');
    }
    
    infoHTML += '<br>';

    infoHTML += ' (';
    infoHTML += event.lat.toFixed(4);
    infoHTML += ', ';
    infoHTML += event.lon.toFixed(4);
    infoHTML += ')'

    setInfoDisplayHTML(infoHTML);
    
    return true;
}

function setInfoDisplayHTML(infoHTML)
{
    var infoElement = document.getElementById('infodisplay');
    infoElement.innerHTML = infoHTML;
}

</script>
</head>

<body style="background-color: #eee;">
<center>

<div style="font-size:200%">
Map visitors to your website
</div>

<div style="font-size:150%">
Upload your Apache access_log file to visualize your visitors
<br/>
<div id="upload_button" class="button">Upload</div>
</div>

<div>

<script type="text/javascript">
insertOpenGraphMap("maprender", "maprender");
</script>

</div>

<div id="infodisplay" style="font-size:150%; height;120px;">
Loading OpenGraphMap
<br/>
<img src="loading.gif"/>
</div>

<div>
<a href="http://petewarden.typepad.com/">By Pete Warden</a>&nbsp;&nbsp;&nbsp;&nbsp;
<a href="http://opengraphmap.org/">OpenGraphMap</a>
</div>

</center>
</body>
</html>
