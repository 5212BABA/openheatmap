<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>World Bank Data Explorer</title>
<link rel="stylesheet" type="text/css" href="history/history.css" />
<script src="AC_OETags.js" language="javascript"></script>
<script src="history/history.js" language="javascript"></script>
<script src="series_index.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
<style>
body {
	font-family:"lucida grande", "verdana";
	font-size:11px;
	margin:0px;
	padding:0px;
	text-align:left;
}

.maindiv {
    background-color: #fff;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border: 1px solid #000;
    padding: 10px;
    margin: 10px;
    font-size: 100%;
    width: 1050px;
}
</style>
<script type="text/javascript">
var requiredMajorVersion = 9;
var requiredMinorVersion = 0;
var requiredRevision = 124;

function insertOpenGraphMap(source, id)
{
    // Version check for the Flash Player that has the ability to start Player Product Install (6.0r65)
    var hasProductInstall = DetectFlashVer(6, 0, 65);

    // Version check based upon the values defined in globals
    var hasRequestedVersion = DetectFlashVer(requiredMajorVersion, requiredMinorVersion, requiredRevision);

    if ( hasProductInstall && !hasRequestedVersion ) 
    {
        // DO NOT MODIFY THE FOLLOWING FOUR LINES
        // Location visited after installation is complete if installation is required
        var MMPlayerType = (isIE == true) ? "ActiveX" : "PlugIn";
        var MMredirectURL = window.location;
        document.title = document.title.slice(0, 47) + " - Flash Player Installation";
        var MMdoctitle = document.title;

        AC_FL_RunContent(
            "src", "playerProductInstall",
            "FlashVars", "MMredirectURL="+MMredirectURL+'&MMplayerType='+MMPlayerType+'&MMdoctitle='+MMdoctitle+"",
            "width", "1000",
            "height", "500",
            "align", "middle",
            "id", id,
            "quality", "high",
            "bgcolor", "#869ca7",
            "name", "mapview",
            "allowScriptAccess","sameDomain",
            "type", "application/x-shockwave-flash",
            "pluginspage", "http://www.adobe.com/go/getflashplayer"
        );
    } 
    else if (hasRequestedVersion) 
    {
        // if we've detected an acceptable version
        // embed the Flash Content SWF when all tests are passed
        AC_FL_RunContent(
            "src", source,
            "width", "1000",
            "height", "500",
            "align", "middle",
            "id", id,
            "quality", "high",
            "bgcolor", "#869ca7",
            "name", "mapview",
            "allowScriptAccess","sameDomain",
            "type", "application/x-shockwave-flash",
            "pluginspage", "http://www.adobe.com/go/getflashplayer"
        );
    } else {
        var alternateContent = 'Flash not found - '
        + 'This content requires the Adobe Flash Player. '
        + '<a href=http://www.adobe.com/go/getflash/>Get Flash</a>';
        document.write(alternateContent);  // insert non-flash content
    }
}

function getOpenGraphMap(mapName) {
    var isIE = navigator.appName.indexOf("Microsoft") != -1;
    return (isIE) ? window[mapName] : document.getElementById(mapName);
}

</script>

<script type="text/javascript">

function onMapCreated()
{
    var map = getOpenGraphMap("maprender");

    map.setSize(1000, 500);
    map.setLatLonViewingArea(90, -180, -70, 180);
    map.setEventHandler('mousemove', 'onMouseMove');
    map.setEventHandler('datachange', 'onDataChange');
    map.setEventHandler('waysload', 'onWaysLoad');
    map.setEventHandler('valuesload', 'onValuesLoad');
    map.setEventHandler('error', 'onError');
//    map.setGradientValueRange(0, 100);
//    map.setTimeRange('1990-01', '2010-02');
    
    map.loadWaysFromFile('test_data/world_countries.osm');
        
    setInfoDisplayHTML('Loading map<br/><img src="loading.gif"/>');    
}

var g_areWaysLoaded = false;
var g_areValuesLoaded = false;

function onWaysLoad(filename)
{
    g_areWaysLoaded = true;
    
    if (g_areValuesLoaded)
    {
        setInfoDisplayHTML('');
    }
    else
    {
        selectSeries('Mortality rate, under-5 (per 1,000)');
    }
    
    return true;
}

function onValuesLoad(filename)
{
    g_areValuesLoaded = true;
    
    if (g_areWaysLoaded)
    {
        setInfoDisplayHTML('');
    }
    else
    {
        setInfoDisplayHTML('Loading map<br/><img src="loading.gif"/>');    
    }
    
    return true;
}

function onError(message)
{
    setInfoDisplayHTML(message);
}

var g_lastEvent = null;

function onMouseMove(event)
{
    g_lastEvent = event;

    updateInfoDisplay(event);
    
    return true;
}

function onDataChange()
{
    updateInfoDisplay(g_lastEvent);
    
    return true;
}

function updateInfoDisplay(event)
{
    if (!g_areWaysLoaded||!g_areValuesLoaded)
        return;

    var map = getOpenGraphMap("maprender");

    var infoHTML = '';

    var ways = map.getWaysContainingLatLon(event.lat, event.lon);
    var waysLength = ways.length;
    if (waysLength<1)
    {
        infoHTML += 'Nothing found';
    }
    else
    {
        var wayNames = [];
        for (var wayIndex in ways)
        {
            var way = ways[wayIndex];
            
            var wayTags = way.tags;
            
            var areaName = wayTags.name;
            
            var description = areaName;

            var wayId = way.id;
            var value = map.getValueForWayId(wayId);
            
            if (value!==null)
            {
                description += ' - ';
                var valueAsNumber = Number(value);
                description += valueAsNumber.toFixed(1);
            }
            else
            {
                description += ' - NA';
            }
            
            wayNames.push(description);
        }
    
        infoHTML += wayNames.join(',');
    }
    
    infoHTML += '<br>';

//    infoHTML += ' (';
//    infoHTML += event.lat.toFixed(4);
//    infoHTML += ', ';
//    infoHTML += event.lon.toFixed(4);
//    infoHTML += ')'

    setInfoDisplayHTML(infoHTML);
    
    return true;
}

function setInfoDisplayHTML(infoHTML)
{
    var infoElement = document.getElementById('infodisplay');
    infoElement.innerHTML = infoHTML;
}

var g_topics = {};

$(document).ready(function(){

    var foundTopics = {};
    var topicList = [];

    for (var index in g_seriesIndex)
    {
        var currentRow = g_seriesIndex[index];
        
        var seriesName = currentRow['Series Name'];
        var topic = currentRow['Topic'];
        var subTopic = currentRow['SubTopic1'];
        
        if (topic === null)
            continue;

        if (subTopic === null)
            continue;
    
        if (!foundTopics.hasOwnProperty(topic))
        {
            foundTopics[topic] = {subTopicList:[], subTopicMap:{}};
            topicList.push(topic);
        }
               
        if (!foundTopics[topic].subTopicMap.hasOwnProperty(subTopic))
        {
            foundTopics[topic].subTopicMap[subTopic] = [];
            foundTopics[topic].subTopicList.push(subTopic);
        }
        
        foundTopics[topic].subTopicMap[subTopic].push(seriesName);
    }
    
    topicList.sort();
    for (var index in topicList)
    {
        var topic = topicList[index];
        
        g_topics[topic] = {};
        
        var subTopicList = foundTopics[topic].subTopicList;
        subTopicList.sort();
        
        for (var subTopicIndex in subTopicList)
        {
            var subTopic = subTopicList[subTopicIndex];
            
            var seriesList = foundTopics[topic].subTopicMap[subTopic];
            seriesList.sort();
            
            g_topics[topic][subTopic] = seriesList;
        }
    }

});

var g_selectedTopic = '';
var g_selectedSubTopic = '';
var g_selectedSeriesName = '';

function selectSeries(selectedSeriesName)
{
    for (var topic in g_topics)
    {
        for (var subTopic in g_topics[topic])
        {
            var seriesList = g_topics[topic][subTopic];
            for (var seriesNameIndex in seriesList)
            {
                var seriesName = seriesList[seriesNameIndex];
                
                if (seriesName===selectedSeriesName)
                {
                    g_selectedTopic = topic;
                    g_selectedSubTopic = subTopic;
                    g_selectedSeriesName = selectedSeriesName;

                    g_areValuesLoaded = false;
                    setInfoDisplayHTML('Loading data<br/><img src="loading.gif"/>');    

                    var map = getOpenGraphMap("maprender");
                    map.loadValuesFromFile('test_data/world_bank_data/'+
                        encodeURIComponent(g_selectedSeriesName));
                        
                }
            }
        }
    }
    
    populatePickers();
}

function populatePickers()
{
    var topicPicker = $('#topicpicker');
    topicPicker.empty();
    
    for (var topic in g_topics)
    {
        var originalColor;
        if (topic===g_selectedTopic)
            originalColor = '#0000ff';
        else
            originalColor = '#000000';
    
        var topicSpan = $('<span></span>')
        .text(topic)
        .css({cursor: "pointer", color: originalColor})
        .click(function() {
            g_selectedTopic = $(this).text();
            g_selectedSubTopic = '';
            g_selectedSeriesName = '';
            populatePickers();
        })
        .append($('<br>'));

        if (topic===g_selectedTopic)
        {
            topicSpan.hover(
                function () {
                    $(this).css({color:'#ff0000'});
                }, function () {
                    $(this).css({color:'#0000ff'});
            });
        }
        else
        {
            topicSpan.hover(
                function () {
                    $(this).css({color:'#ff0000'});
                }, function () {
                    $(this).css({color:'#000000'});
            });        
        }
        
        topicPicker.append(topicSpan);
    }

    var subTopicPicker = $('#subtopicpicker');
    subTopicPicker.empty();
    
    for (var subTopic in g_topics[g_selectedTopic])
    {
        var originalColor;
        if (subTopic===g_selectedSubTopic)
            originalColor = '#0000ff';
        else
            originalColor = '#000000';
    
        var subTopicSpan = $('<span></span>')
        .text(subTopic)
        .css({cursor: "pointer", color: originalColor})
        .click(function() {
            g_selectedSubTopic = $(this).text();
            g_selectedSeriesName = '';
            populatePickers();
        })
        .append($('<br>'));
        
        if (subTopic===g_selectedSubTopic)
        {
            subTopicSpan.hover(
                function () {
                    $(this).css({color:'#ff0000'});
                }, function () {
                    $(this).css({color:'#0000ff'});
            });
        }
        else
        {
            subTopicSpan.hover(
                function () {
                    $(this).css({color:'#ff0000'});
                }, function () {
                    $(this).css({color:'#000000'});
            });        
        }

        
        subTopicPicker.append(subTopicSpan);
    }

    var seriesNamePicker = $('#seriesnamepicker');
    seriesNamePicker.empty();
    
    for (var seriesNameIndex in g_topics[g_selectedTopic][g_selectedSubTopic])
    {
        var seriesName = g_topics[g_selectedTopic][g_selectedSubTopic][seriesNameIndex];

        var originalColor;
        if (seriesName===g_selectedSeriesName)
            originalColor = '#0000ff';
        else
            originalColor = '#000000';
    
        var seriesNameSpan = $('<span></span>')
        .text(seriesName)
        .css({cursor: "pointer", color: originalColor, fontSize:'100%'})
        .click(function() {
            selectSeries($(this).text());
        })
        .append($('<br>'));
        
        if (seriesName===g_selectedSeriesName)
        {
            seriesNameSpan.hover(
                function () {
                    $(this).css({color:'#ff0000'});
                }, function () {
                    $(this).css({color:'#0000ff'});
            });
        }
        else
        {
            seriesNameSpan.hover(
                function () {
                    $(this).css({color:'#ff0000'});
                }, function () {
                    $(this).css({color:'#000000'});
            });        
        }

        seriesNamePicker.append(seriesNameSpan);
    }

}

</script>
</head>

<body style="background-color: #eee;">
<center>

<div class="maindiv" style="font-size:200%">
World Bank Data Explorer
</div>

<div class="maindiv">

<script type="text/javascript">
insertOpenGraphMap("maprender", "maprender");
</script>

</div>

<div class="maindiv" id="infodisplay" style="font-size:150%; height;120px;">
Loading OpenGraphMap
<br/>
<img src="loading.gif"/>
</div>

<div class="maindiv" id="datasetchooser" style="font-size:125%">
<div id="topicpicker" style="float: left; width: 20%; border-right: 1px solid #000; text-align: right; padding-right: 3px;">
</div>
<div id="subtopicpicker" style="float: left; width: 15%; border-right: 1px solid #000; text-align: right; padding-right: 3px;">
</div>
<div id="seriesnamepicker" style="float: left; width: 60%; text-align: right; padding-right: 3px; font-size:90%;">
</div>
<br clear="all" />
</div>

<div class="maindiv">
<a href="http://petewarden.typepad.com/">By Pete Warden</a>&nbsp;&nbsp;&nbsp;&nbsp;
<a href="http://openheatmap.com/">OpenHeatMap</a>
</div>

</center>
</body>
</html>
